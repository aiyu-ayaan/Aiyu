#!/bin/bash

# Crypto Miner Cleanup Script
# This script helps remove the crypto miner malware from your system
#
# Usage: ./cleanup-malware.sh [--force|--yes|-y]
#   --force, --yes, -y: Skip confirmation prompts (for automated execution)

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${RED}======================================${NC}"
echo -e "${RED}   Crypto Miner Cleanup Script       ${NC}"
echo -e "${RED}======================================${NC}"
echo ""

# Check if running as root
if [ "$EUID" -ne 0 ]; then 
    echo -e "${YELLOW}Warning: This script should be run as root for complete cleanup${NC}"
    echo "Some operations may fail without root privileges"
    echo ""
fi

# Step 1: Stop the application
echo -e "${GREEN}Step 1: Stopping Next.js application...${NC}"
if command -v docker-compose &> /dev/null; then
    docker-compose down 2>/dev/null || echo "No docker-compose found or already stopped"
fi
pkill -f next-server 2>/dev/null || echo "No next-server process found"
pkill -f ijnegrrinje 2>/dev/null || echo "No ijnegrrinje process found"
sleep 2

# Step 2: Find and remove malicious files
echo -e "${GREEN}Step 2: Searching for malicious files...${NC}"
MALICIOUS_FILES=$(find /tmp /var/tmp -name "*ijnegrrinje*" 2>/dev/null || true)

if [ -n "$MALICIOUS_FILES" ]; then
    echo -e "${RED}Found malicious files:${NC}"
    echo "$MALICIOUS_FILES"
    echo ""
    
    # Check for --force or --yes flag
    if [[ "$*" == *"--force"* ]] || [[ "$*" == *"--yes"* ]] || [[ "$*" == *"-y"* ]]; then
        find /tmp /var/tmp -name "*ijnegrrinje*" -delete 2>/dev/null
        echo -e "${GREEN}Malicious files removed (forced)${NC}"
    else
        read -p "Do you want to remove these files? (y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            find /tmp /var/tmp -name "*ijnegrrinje*" -delete 2>/dev/null
            echo -e "${GREEN}Malicious files removed${NC}"
        fi
    fi
else
    echo "No malicious files found in /tmp or /var/tmp"
fi

# Step 3: Check for suspicious processes
echo -e "${GREEN}Step 3: Checking for suspicious processes...${NC}"
SUSPICIOUS_PROCS=$(ps aux | grep -E "(ijnegrrinje|xmrig|minerd|cpuminer)" | grep -v grep || true)
if [ -n "$SUSPICIOUS_PROCS" ]; then
    echo -e "${RED}Found suspicious processes:${NC}"
    echo "$SUSPICIOUS_PROCS"
    echo ""
    echo "Please manually investigate and kill these processes if necessary"
else
    echo "No suspicious processes found"
fi

# Step 4: Check cron jobs
echo -e "${GREEN}Step 4: Checking for malicious cron jobs...${NC}"
if [ -f /etc/crontab ]; then
    CRON_MALWARE=$(grep -E "(ijnegrrinje|wget|curl.*\.sh)" /etc/crontab 2>/dev/null || true)
    if [ -n "$CRON_MALWARE" ]; then
        echo -e "${RED}Found suspicious cron entries in /etc/crontab:${NC}"
        echo "$CRON_MALWARE"
        echo -e "${YELLOW}Please manually review and remove suspicious entries${NC}"
    fi
fi

USER_CRON=$(crontab -l 2>/dev/null || true)
if [ -n "$USER_CRON" ]; then
    CRON_MALWARE=$(echo "$USER_CRON" | grep -E "(ijnegrrinje|wget|curl.*\.sh)" || true)
    if [ -n "$CRON_MALWARE" ]; then
        echo -e "${RED}Found suspicious cron entries for current user:${NC}"
        echo "$CRON_MALWARE"
        echo -e "${YELLOW}Run 'crontab -e' to review and remove suspicious entries${NC}"
    fi
fi

# Step 5: Check systemd services
echo -e "${GREEN}Step 5: Checking for malicious systemd services...${NC}"
if command -v systemctl &> /dev/null; then
    SUSPICIOUS_SERVICES=$(systemctl list-units --type=service --state=running | grep -E "(ijnegrrinje|miner|xmrig)" || true)
    if [ -n "$SUSPICIOUS_SERVICES" ]; then
        echo -e "${RED}Found suspicious services:${NC}"
        echo "$SUSPICIOUS_SERVICES"
        echo -e "${YELLOW}Please manually investigate and disable suspicious services${NC}"
    fi
fi

# Step 6: Check network connections
echo -e "${GREEN}Step 6: Checking for suspicious network connections...${NC}"
SUSPICIOUS_CONN=$(netstat -tulpn 2>/dev/null | grep -E ":(3333|8080|8333|14444)" || true)
if [ -n "$SUSPICIOUS_CONN" ]; then
    echo -e "${RED}Found suspicious network connections (common mining ports):${NC}"
    echo "$SUSPICIOUS_CONN"
fi

# Step 7: Search for additional malicious files
echo -e "${GREEN}Step 7: Searching for recently modified files in /tmp...${NC}"
RECENT_FILES=$(find /tmp -type f -mtime -1 -ls 2>/dev/null | head -20 || true)
if [ -n "$RECENT_FILES" ]; then
    echo "Recently modified files in /tmp (last 24 hours):"
    echo "$RECENT_FILES"
    echo ""
fi

# Step 8: Check for rootkits (if rkhunter is installed)
if command -v rkhunter &> /dev/null; then
    echo -e "${GREEN}Step 8: Running rootkit check...${NC}"
    echo -e "${YELLOW}This may take a few minutes...${NC}"
    rkhunter --check --skip-keypress --report-warnings-only 2>/dev/null || echo "Rootkit check completed (see output above)"
else
    echo -e "${GREEN}Step 8: Skipping rootkit check${NC}"
    echo "Install rkhunter for rootkit detection: sudo apt-get install rkhunter"
fi

# Step 9: Clean npm and Docker caches
echo -e "${GREEN}Step 9: Cleaning npm and Docker caches...${NC}"
if [ -d "node_modules" ]; then
    echo "Removing node_modules directory..."
    rm -rf node_modules
fi

if [ -f "package-lock.json" ]; then
    echo "Removing package-lock.json..."
    rm -f package-lock.json
fi

if command -v docker &> /dev/null; then
    echo "Cleaning Docker system..."
    docker system prune -af --volumes 2>/dev/null || echo "Docker cleanup completed"
fi

if command -v npm &> /dev/null; then
    echo "Cleaning npm cache..."
    npm cache clean --force 2>/dev/null || echo "npm cache cleaned"
fi

# Step 10: Security recommendations
echo ""
echo -e "${GREEN}======================================${NC}"
echo -e "${GREEN}   Cleanup Complete                  ${NC}"
echo -e "${GREEN}======================================${NC}"
echo ""
echo -e "${YELLOW}Next Steps:${NC}"
echo "1. Review the SECURITY_REMEDIATION.md file for detailed hardening steps"
echo "2. Update all dependencies: npm install"
echo "3. Run security audit: npm audit"
echo "4. Rebuild Docker containers: docker-compose build --no-cache"
echo "5. Update all passwords and secrets in .env file"
echo "6. Enable firewall: sudo ufw enable"
echo "7. Monitor system resources: htop or top"
echo "8. Check logs regularly: docker-compose logs -f"
echo ""
echo -e "${RED}IMPORTANT:${NC}"
echo "- Change ALL passwords (system, database, application)"
echo "- Rotate ALL API keys and secrets"
echo "- Review ALL system access logs"
echo "- Consider rebuilding the server if rootkit is detected"
echo ""
echo -e "${GREEN}For support, refer to: SECURITY_REMEDIATION.md${NC}"
